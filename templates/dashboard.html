{% extends "base.html" %} {% block title %}Dashboard - Task Manager{% endblock
%} {% block content %}
<div style="padding: 4rem 2rem 2rem 2rem">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <h1 class="h2 text-white">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
      </h1>
      <a href="{{ url_for('create_task') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>New Task
      </a>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="card-title">{{ tasks|length }}</h4>
                <p class="card-text">Total Tasks</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-tasks fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="card-title">
                  {{ tasks|selectattr('status', 'equalto',
                  'pending')|list|length }}
                </h4>
                <p class="card-text">Pending</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-clock fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="card-title">
                  {{ tasks|selectattr('status', 'equalto',
                  'in_progress')|list|length }}
                </h4>
                <p class="card-text">In Progress</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-play fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="card-title">
                  {{ tasks|selectattr('status', 'equalto',
                  'completed')|list|length }}
                </h4>
                <p class="card-text">Completed</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-check fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks List -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 text-white">
          <i class="fas fa-list me-2"></i>Your Tasks
        </h5>
      </div>
      <div class="card-body">
        {% if tasks %}
        <div class="row">
          {% for task in tasks %}
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 task-card" data-task-id="{{ task.id }}">
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-start mb-2"
                >
                  <h6 class="card-title mb-0 text-white">{{ task.title }}</h6>
                  <div class="dropdown">
                    <button
                      class="btn btn-sm btn-outline-secondary dropdown-toggle"
                      type="button"
                      data-bs-toggle="dropdown"
                    >
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <a
                          class="dropdown-item"
                          href="{{ url_for('edit_task', task_id=task.id) }}"
                        >
                          <i class="fas fa-edit me-2"></i>Edit
                        </a>
                      </li>
                      <li>
                        <a
                          class="dropdown-item text-danger"
                          href="{{ url_for('delete_task', task_id=task.id) }}"
                          onclick="return confirm('Are you sure you want to delete this task?')"
                        >
                          <i class="fas fa-trash me-2"></i>Delete
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>

                {% if task.description %}
                <p class="card-text small text-white-50">
                  {{ task.description[:100] }}{% if task.description|length >
                  100 %}...{% endif %}
                </p>
                {% endif %}

                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <span
                      class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'secondary' }}"
                    >
                      {{ task.priority.title() }}
                    </span>
                    <span
                      class="badge bg-{{ 'success' if task.status == 'completed' else 'info' if task.status == 'in_progress' else 'warning' }}"
                    >
                      {{ task.status.replace('_', ' ').title() }}
                    </span>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input task-toggle" type="checkbox"
                    data-task-id="{{ task.id }}" {% if task.status ==
                    'completed' %}checked{% endif %}>
                    <label class="form-check-label small">Done</label>
                  </div>
                </div>

                <small class="text-white-50">
                  <i class="fas fa-calendar me-1"></i>
                  {{ task.created_at.strftime('%b %d, %Y') }}
                </small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
          <i
            class="fas fa-tasks fa-3x mb-3"
            style="color: var(--text-muted)"
          ></i>
          <h5 class="text-white">No tasks yet</h5>
          <p class="text-white-50">Create your first task to get started!</p>
          <a href="{{ url_for('create_task') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Task
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const taskToggles = document.querySelectorAll(".task-toggle");

    taskToggles.forEach((toggle) => {
      toggle.addEventListener("change", function () {
        const taskId = this.dataset.taskId;
        const taskCard = this.closest(".task-card");

        // Disable checkbox during request
        this.disabled = true;
        this.style.opacity = "0.6";

        fetch(`/toggle_task/${taskId}`)
          .then((response) => {
            console.log("Response status:", response.status);
            return response.json();
          })
          .then((data) => {
            console.log("Response data:", data);
            if (data.status) {
              // Update the status badge - find the status badge specifically
              const badges = taskCard.querySelectorAll(".badge");
              const statusBadge = badges[badges.length - 1]; // Last badge is the status badge
              console.log(
                "Found badges:",
                badges.length,
                "Status badge:",
                statusBadge
              );

              if (statusBadge) {
                if (data.status === "completed") {
                  statusBadge.textContent = "Completed";
                  statusBadge.className = "badge bg-success";
                  // Add visual feedback for completed task
                  taskCard.style.opacity = "0.7";
                  taskCard.style.transform = "scale(0.98)";
                } else {
                  statusBadge.textContent = "Pending";
                  statusBadge.className = "badge bg-warning";
                  // Remove visual feedback for pending task
                  taskCard.style.opacity = "1";
                  taskCard.style.transform = "scale(1)";
                }
              } else {
                console.error("Status badge not found");
                // Fallback: reload the page to show updated status
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              }

              // Show success message
              if (window.TaskManager && window.TaskManager.showToast) {
                const message =
                  data.status === "completed"
                    ? "Task marked as completed!"
                    : "Task marked as pending!";
                window.TaskManager.showToast(message, "success");
              }
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            this.checked = !this.checked; // Revert the checkbox
            if (window.TaskManager && window.TaskManager.showToast) {
              window.TaskManager.showToast(
                "Failed to update task status",
                "error"
              );
            }
          })
          .finally(() => {
            // Re-enable checkbox
            this.disabled = false;
            this.style.opacity = "1";
          });
      });
    });
  });
</script>
{% endblock %}
